<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>hw8</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
html {
font-size: 100%;
overflow-y: scroll;
-webkit-text-size-adjust: 100%;
-ms-text-size-adjust: 100%;
}
body {
color: #000;
font-family: Georgia, Palatino, 'Palatino Linotype', Times, 'Times New Roman', serif;
font-size: 12px;
line-height: 1.7;
padding: 1em;
margin: auto;
max-width: 42em;
background: #fefefe;
}
a {
color: #0645ad;
text-decoration: none;
}
a:visited {
color: #0b0080;
}
a:hover {
color: #06e;
}
a:active {
color: #faa700;
}
a:focus {
outline: thin dotted;
}
*::-moz-selection {
background: rgba(255, 255, 0, 0.3);
color: #000;
}
*::selection {
background: rgba(255, 255, 0, 0.3);
color: #000;
}
a::-moz-selection {
background: rgba(255, 255, 0, 0.3);
color: #0645ad;
}
a::selection {
background: rgba(255, 255, 0, 0.3);
color: #0645ad;
}
p {
margin: 1em 0;
}
img {
max-width: 100%;
}
h1, h2, h3, h4, h5, h6 {
color: #111;
line-height: 125%;
margin-top: 2em;
font-weight: normal;
}
h4, h5, h6 {
font-weight: bold;
}
h1 {
font-size: 2.5em;
}
h2 {
font-size: 2em;
}
h3 {
font-size: 1.5em;
}
h4 {
font-size: 1.2em;
}
h5 {
font-size: 1em;
}
h6 {
font-size: 0.9em;
}
blockquote {
color: #666666;
margin: 0;
padding-left: 3em;
border-left: 0.5em #EEE solid;
}
hr {
display: block;
height: 2px;
border: 0;
border-top: 1px solid #aaa;
border-bottom: 1px solid #eee;
margin: 1em 0;
padding: 0;
}
pre, code, kbd, samp {
color: #000;
font-family: monospace, monospace;
_font-family: 'courier new', monospace;
font-size: 0.98em;
background-color: #eee;
padding-left: 5px;
padding-right: 5px;
}
pre {
white-space: pre;
white-space: pre-wrap;
word-wrap: break-word;
}
b, strong {
font-weight: bold;
}
dfn {
font-style: italic;
}
ins {
background: #ff9;
color: #000;
text-decoration: none;
}
mark {
background: #ff0;
color: #000;
font-style: italic;
font-weight: bold;
}
sub, sup {
font-size: 75%;
line-height: 0;
position: relative;
vertical-align: baseline;
}
sup {
top: -0.5em;
}
sub {
bottom: -0.25em;
}
ul, ol {
margin: 1em 0;
padding: 0 0 0 2em;
}
li p:last-child {
margin-bottom: 0;
}
ul ul, ol ol {
margin: .3em 0;
}
dl {
margin-bottom: 1em;
}
dt {
font-weight: bold;
margin-bottom: .8em;
}
dd {
margin: 0 0 .8em 2em;
}
dd:last-child {
margin-bottom: 0;
}
img {
border: 0;
-ms-interpolation-mode: bicubic;
vertical-align: middle;
}
figure {
display: block;
text-align: center;
margin: 1em 0;
}
figure img {
border: none;
margin: 0 auto;
}
figcaption {
font-size: 0.8em;
font-style: italic;
margin: 0 0 .8em;
}
table {
margin-bottom: 2em;
border-bottom: 1px solid #ddd;
border-right: 1px solid #ddd;
border-spacing: 0;
border-collapse: collapse;
}
table th {
padding: .2em 1em;
background-color: #eee;
border-top: 1px solid #ddd;
border-left: 1px solid #ddd;
}
table td {
padding: .2em 1em;
border-top: 1px solid #ddd;
border-left: 1px solid #ddd;
vertical-align: top;
}
.author {
font-size: 1.2em;
text-align: center;
}
@media only screen and (min-width: 480px) {
body {
font-size: 14px;
}
}
@media only screen and (min-width: 768px) {
body {
font-size: 16px;
}
}
@media print {
* {
background: transparent !important;
color: black !important;
filter: none !important;
-ms-filter: none !important;
}
body {
font-size: 12pt;
max-width: 100%;
}
a, a:visited {
text-decoration: underline;
}
hr {
height: 1px;
border: 0;
border-bottom: 1px solid black;
}
a[href]:after {
content: " (" attr(href) ")";
}
abbr[title]:after {
content: " (" attr(title) ")";
}
.ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after {
content: "";
}
pre, blockquote {
border: 1px solid #999;
padding-right: 1em;
page-break-inside: avoid;
}
tr, img {
page-break-inside: avoid;
}
img {
max-width: 100% !important;
}
@page :left {
margin: 15mm 20mm 15mm 10mm;
}
@page :right {
margin: 15mm 10mm 15mm 20mm;
}
p, h2, h3 {
orphans: 3;
widows: 3;
}
h2, h3 {
page-break-after: avoid;
}
}</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="homework-8">Homework 8</h1>
<ul>
<li><a href="#homework-8">Homework 8</a>
<ul>
<li><a href="#exercise-1-pet-homomorphic-encryption-for-ml-model-inference">Exercise 1: [PET] Homomorphic Encryption for ML Model Inference</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#ml-model">ML model</a></li>
<li><a href="#cryptographic-parameters">Cryptographic parameters</a></li>
<li><a href="#http-interface">HTTP interface</a></li>
<li><a href="#task">Task</a></li>
</ul></li>
<li><a href="#exercise-2-attack-prediction-as-a-service-model-stealing">Exercise 2: [attack] Prediction-as-a-Service Model Stealing</a>
<ul>
<li><a href="#notes">Notes</a></li>
</ul></li>
</ul></li>
</ul>
<h2 id="exercise-1-pet-homomorphic-encryption-for-ml-model-inference">Exercise 1: [PET] Homomorphic Encryption for ML Model Inference</h2>
<p>A company named SecureHealth provides an API to query what they call a “Health AI” in a private way. According to their website, the company uses some complicated “novel medical AI method”, and sells predictions using their model. A customer can send a feature vector representing different health-related features of a patient as input, and get back a score of how likely is some given diagnosis. Your institution has paid a lot of money to get access to an API to query this model in a privacy-preserving way. That is, without SecureHealth being able to see the feature vector that is submitted to its model, nor the computed output score.</p>
<p>In order to achieve that, SecureHealth relies on homomorphic encryption. Homomorphic encryption is a malleable form of encryption which allows arithmetic operations to be performed on encrypted data without having to decrypt. In particular, they use the <a href="https://en.wikipedia.org/wiki/Paillier_cryptosystem">Paillier Encryption Scheme</a> (see lectures).</p>
<h3 id="setup">Setup</h3>
<p>We simulate the SecureHealth service using a docker container: This container runs the SecureHealth service as a HTTP server, which you can start with:</p>
<pre><code>docker run --rm -p 8000:8000 com402/hw8</code></pre>
<p>Then, you can access the service by making HTTP requests to <code>http://localhost:8000</code> (there is no homepage, visiting the page with your browser will yield a 404).</p>
<h3 id="ml-model">ML model</h3>
<p>The <strong>plaintext</strong> predictive model takes a vector of ten features (extracted from the patient’s data) and outputs a score (probability of disease):</p>
<ul>
<li>The input <span class="math inline"><strong>x</strong></span> is a feature vector of 10 positive, normalized numbers in the range <span class="math inline">[0, 1]</span>.</li>
<li>The output <span class="math inline"><em>y</em></span> score is a probability, hence a positive number in the range <span class="math inline">[0, 1]</span></li>
</ul>
<p>The scoring function is a linear combination of the input features, computed as <span class="math inline"><em>y</em> = <strong>x</strong> ⋅ <strong>w</strong> + <em>b</em></span>, where</p>
<ul>
<li><span class="math inline"><strong>w</strong></span> is the coefficient vector of positive numbers in <span class="math inline">[0, 1]</span></li>
<li><span class="math inline"><em>b</em></span> is a bias term in <span class="math inline">[0, 1]</span></li>
</ul>
<p>In our case, the interface accepts <strong>encrypted</strong> inputs, computes the score using <strong>encrypted</strong> arithmetic and yields <strong>encrypted</strong> outputs.</p>
<h3 id="cryptographic-parameters">Cryptographic parameters</h3>
<p>The prediction service expects the following cryptographic parameters for the public key and ciphertexts.</p>
<p>Paillier public key:</p>
<ul>
<li>Modulus (<span class="math inline"><em>N</em></span>) bit-length: 2048</li>
<li>Generator (<span class="math inline"><em>g</em></span>): <span class="math inline"><em>N</em> + 1</span></li>
</ul>
<p>Paillier ciphertexts:</p>
<ul>
<li>Fixed-point encoding precision: 16 bits</li>
</ul>
<h3 id="http-interface">HTTP interface</h3>
<p>Here are the details of their HTTP interface.</p>
<ul>
<li><code>POST /prediction</code>
<ul>
<li>Request body, a JSON-object with the following fields:
<ul>
<li><code>pub_key_n</code>: the Paillier public key modulus <span class="math inline"><em>N</em></span>, an integer in the base-10 representation</li>
<li><code>enc_feature_vector</code>: the encrypted feature vector, a JSON-array of integers in the base-10 representation</li>
</ul></li>
<li>Responses:
<ul>
<li><code>200</code> (json):
<ul>
<li><code>enc_prediction</code>: the encrypted prediction, an integer in the base-10 representation</li>
</ul></li>
<li><code>40x</code> (text):
<ul>
<li>error message</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p>Note: The <code>requests.post([URL], json=[JSON object])</code> function sends a post request with the appropriate heads and JSON body.</p>
<h3 id="task">Task</h3>
<p>Your first task is to implement a client to query the SecureHealth model API.</p>
<p>You may find the <a href="https://python-paillier.readthedocs.io/en/develop/">python-paillier</a> library useful. It is well documented, and its <em>docstring</em> documentation (<code>help(paillier)</code>) is really useful in understanding both the implementation details and the Paillier cryptosystem usage.</p>
<p>[Optional] Even though the server is provided to you, understanding the homomorphic computation it performs is part of the homework. You might want to try to implement this part yourself, as it is key to understand how to work with the Paillier scheme for floating point values. The english <a href="https://en.wikipedia.org/wiki/Paillier_cryptosystem">wikipedia article</a> is a good starting point.</p>
<p>Since the Paillier encryption scheme supports integer plaintext messages, floating point values need to be encoded as integers before encryption, and decoded back to floating points value after decryption. This encoding is usually done by scaling the plaintext up by a constant, and scaling it down at decoding. Indeed, the higher the constant, the higher the <em>precision</em>, but this has some other side-effect too. You will need to investigate the details of these side effect as they are key for the correctness of the output, and is part of this homework.</p>
<p><strong>Note</strong>: the weight vector <span class="math inline"><strong>w</strong></span> that the server uses is also encoded in the fixed-point representation. You should keep track of how the server’s computation changes the scaling constant.</p>
<p><strong>Tip</strong>: You can either convert reals into their fixed-point representations manually, or use the provided <code>precision</code> and <code>exponent</code> parameters of the Paillier library.</p>
<p><strong>Tip 2</strong>: The code to encrypt/query/decrypt is rather straightforward, and not really what we teach you with that exercise. But one of the main important aspect, that you need to understand, is how the scaling works, and what the parameters <code>precision</code> and <code>exponent</code> are. Get some paper, you’ll need it.</p>
<p>You can use the following test vector to test your implementation (given that your client implements the API querying logic in <code>query_pred</code>):</p>
<pre><code>assert 2**(-16) &gt; abs(query_pred([0.48555949, 0.29289251, 0.63463107,
                                  0.41933057, 0.78672205, 0.58910837,
                                  0.00739207, 0.31390802, 0.37037496,
                                  0.3375726 ]) - 0.44812144746653826)</code></pre>
<h2 id="exercise-2-attack-prediction-as-a-service-model-stealing">Exercise 2: [attack] Prediction-as-a-Service Model Stealing</h2>
<p>You found an interview of a former SecureHealth chief data scientist. You realized that their “AI” actually uses a linear regression (hence, the linear scoring function…). Having paid a lot of money to query “an advanced AI”, you feel somewhat betrayed and decide to end the subscription. But before that, you want to perform a <em>long term, unilateral, model sharing</em> (i.e., steal it).</p>
<p>Your task is to write a program that extracts the model parameters using the prediction API. Also think about a way of validating that the extracted parameters are correct.</p>
<h3 id="notes">Notes</h3>
<p>As you might have already noticed, the server implements a (very basic) protection against a (very basic) attack.</p>
</body>
</html>
